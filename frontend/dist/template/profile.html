<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../css/profile.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .profile-container {
      display: flex;
      gap: 30px;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .profile-sidebar {
      width: 250px;
      text-align: center;
    }
    .profile-image-container {
      position: relative;
      margin: 0 auto 20px;
      width: 150px;
    }
    .profile-image {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      border: 5px solid #f0f0f0;
    }
    .edit-image-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: #1976d2;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .profile-content {
      flex: 1;
    }
    .profile-name {
      font-size: 1.5rem;
      margin-bottom: 5px;
    }
    .profile-email {
      color: #666;
      margin-bottom: 20px;
    }
    .profile-detail {
      margin-bottom: 15px;
    }
    .detail-label {
      font-size: 0.8rem;
      color: #666;
    }
    .detail-value {
      font-weight: 500;
    }
    .tab-container {
      margin-top: 20px;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
    }
    .tab.active {
      border-bottom: 2px solid #1976d2;
      color: #1976d2;
      font-weight: 500;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #666;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: inherit;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      padding: 10px 15px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #1565c0;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    .message {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .success {
      background: #e6ffed;
      color: #2d7a4d;
    }
    .error {
      background: #ffebee;
      color: #c62828;
    }
    .hidden {
      display: none;
    }
    #image-preview-container {
      text-align: center;
      margin: 15px 0;
    }
    #image-preview {
      max-width: 200px;
      max-height: 200px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>User Profile</h3>
        </div>
        <ul class="menu-list">
            <li><a href="../template/dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="./course.html"><i class="fas fa-book-open"></i> Courses</a></li>
            <li><a href="./profile.html" class="active"><i class="fas fa-user"></i> Profile</a></li>
            <li><a href="./student.html"><i class="fas fa-graduation-cap"></i> Results</a></li>
            <li><a href="./index.html"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content" id="mainContent">
        <header>
            <div class="welcome">
                <h1>My Profile</h1>
            </div>
            <div id="theme-toggle" class="theme-toggle">
                <i id="sun-icon" class="fas fa-sun"></i>
            </div>
        </header>
  <div class="profile-container">
    <div class="profile-sidebar">
      <div class="profile-image-container">
        <img id="profile-image" class="profile-image" src="../../backend/public/uploads/default-avatar.png" alt="Profile">
        <button class="edit-image-btn" id="edit-image-btn">
          <i class="fas fa-camera"></i>
        </button>
        <input type="file" id="image-upload" accept="image/*" class="hidden">
      </div>
      
      <div id="image-preview-container" class="hidden">
        <p>New Image Preview:</p>
        <img id="image-preview" src="" alt="Preview">
        <div class="btn-group">
          <button id="cancel-upload" class="btn-secondary">Cancel</button>
          <button id="confirm-upload" class="btn-primary">Save Image</button>
        </div>
      </div>
      
      <h1 id="profile-name" class="profile-name">Loading...</h1>
      <div id="profile-email" class="profile-email"></div>
      
      <div class="profile-details">
        <div class="profile-detail">
          <div class="detail-label">Age</div>
          <div id="profile-age" class="detail-value">--</div>
        </div>
        <div class="profile-detail">
          <div class="detail-label">Location</div>
          <div id="profile-location" class="detail-value">--</div>
        </div>
      </div>
    </div>
    
    <div class="profile-content">
      <div class="tabs">
        <div class="tab active" data-tab="about">About</div>
        <div class="tab" data-tab="edit">Edit Profile</div>
      </div>
      
      <div id="message" class="message"></div>
      
      <div id="about-tab" class="tab-content active">
        <h2>About Me</h2>
        <p id="about-text">Loading...</p>
      </div>
      
      <div id="edit-tab" class="tab-content">
        <form id="profile-form">
          <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" required>
          </div>
          <div class="form-group">
            <label for="age">Age</label>
            <input type="number" id="age" min="1">
          </div>
          <div class="form-group">
            <label for="location">Location</label>
            <input type="text" id="location">
          </div>
          <div class="form-group">
            <label for="about">About Me</label>
            <textarea id="about"></textarea>
          </div>
          <button type="submit" id="save-btn">Save Changes</button>
        </form>
      </div>
    </div>
  </main>
    <div class="fab" id="fab">
      <i class="fas fa-bars"></i>
  </div>
  </div>
  <script>

    
    // Utility functions
    const BASE_IMAGE_PATH = '../public/uploads/';
     
    function showMessage(type, text) {
      const msgEl = document.getElementById('message');
      msgEl.textContent = text;
      msgEl.className = `message ${type}`;
      setTimeout(() => {
        msgEl.textContent = '';
        msgEl.className = 'message';
      }, 5000);
    }

    // Tab functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab') + '-tab';
        document.getElementById(tabId).classList.add('active');
      });
    });

    // Image upload functionality
    const editImageBtn = document.getElementById('edit-image-btn');
    const imageUpload = document.getElementById('image-upload');
    const previewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const cancelUploadBtn = document.getElementById('cancel-upload');
    const confirmUploadBtn = document.getElementById('confirm-upload');

    editImageBtn.addEventListener('click', () => imageUpload.click());

    imageUpload.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        imagePreview.src = URL.createObjectURL(file);
        previewContainer.classList.remove('hidden');
      }
    });

    cancelUploadBtn.addEventListener('click', () => {
      imageUpload.value = '';
      previewContainer.classList.add('hidden');
    });

    confirmUploadBtn.addEventListener('click', async () => {
      const file = imageUpload.files[0];
      if (!file) return;

      const token = localStorage.getItem('token');
      if (!token) {
        showMessage('error', 'Please login first');
        return;
      }

      const formData = new FormData();
      formData.append('image', file);

      try {
        confirmUploadBtn.disabled = true;
        confirmUploadBtn.textContent = 'Uploading...';

        const res = await fetch('http://localhost:5000/api/v1/profile/image', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData
        });

        const data = await res.json();
        if (res.ok) {
          document.getElementById('profile-image').src = data.imageUrl;
          previewContainer.classList.add('hidden');
          imageUpload.value = '';
          showMessage('success', 'Profile image updated successfully!');
        } else {
          throw new Error(data.error || 'Failed to upload image');
        }
      } catch (err) {
        showMessage('error', err.message);
      } finally {
        confirmUploadBtn.disabled = false;
        confirmUploadBtn.textContent = 'Save Image';
      }
    });

    // Profile form submission
    document.getElementById('profile-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const token = localStorage.getItem('token');
      if (!token) {
        showMessage('error', 'Please login first');
        return;
      }

      const formData = {
        name: document.getElementById('name').value,
        age: document.getElementById('age').value,
        location: document.getElementById('location').value,
        about: document.getElementById('about').value
      };

      const saveBtn = document.getElementById('save-btn');
      try {
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const res = await fetch('http://localhost:5000/api/v1/profile', {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const data = await res.json();
        if (res.ok) {
          // Update the displayed profile
          document.getElementById('profile-name').textContent = data.name || 'Anonymous';
          document.getElementById('profile-age').textContent = data.age || '--';
          document.getElementById('profile-location').textContent = data.location || '--';
          document.getElementById('about-text').textContent = data.about || 'No information provided.';
          
          // Switch back to about tab
          document.querySelector('.tab[data-tab="about"]').click();
          showMessage('success', 'Profile updated successfully!');
        } else {
          throw new Error(data.error || 'Failed to update profile');
        }
      } catch (err) {
        showMessage('error', err.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    });

    async function loadProfile() {
      try {
        const token = localStorage.getItem('token');
        if (!token) throw new Error('Not logged in');
    
        const res = await fetch('http://localhost:5000/api/v1/profile/me', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
    
        if (res.status === 404) {
          // Only create profile if we have basic user data
          const userRes = await fetch('http://localhost:5000/api/v1/user', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (!userRes.ok) throw new Error('Failed to fetch user data');
          
          const userData = await userRes.json();
          
          const createRes = await fetch('http://localhost:5000/api/v1/profile', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: userData.name,
              email: userData.email
            })
          });
          
          if (!createRes.ok) throw new Error('Failed to create profile');
          
          const newProfile = await createRes.json();
          return newProfile;
        }
        
        const data = await res.json();
        // Update your UI with data
        updateProfileUI(data);
        
      } catch (err) {
        console.error('Profile load error:', err);
        showMessage('error', 'Failed to load profile. Please try again.');
        
        if (err.message.includes('401')) {
          localStorage.removeItem('token');
          window.location.href = '/login.html';
        }
      }
    }


    function updateProfileUI(data) {
      const setElementText = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.textContent = text || '--';
      };
      // ... other field updates ...
      // Update all fields
      setElementText('profile-name', data.name);
      setElementText('profile-email', data.email);
      setElementText('profile-age', data.age);
      setElementText('profile-location', data.location);
      setElementText('about-text', data.about);
      const nameInput = document.getElementById('name');
      if (nameInput) nameInput.value = data.name || '';
    
      // Handle image with proper URL construction
      const setImage = (id, src) => {
        const img = document.getElementById(id);
        if (img) {
          // If src is already a full URL, use it directly
          if (src && (src.startsWith('http://') || src.startsWith('https://'))) {
            img.src = src;
          } 
          // If src is a relative path, construct full URL to your API server
          else if (src) {
            img.src = `http://localhost:5000${src.startsWith('/') ? src : `/${src}`}`;
          }
          // Fallback to default avatar
          else {
            img.src = 'http://localhost:5000/uploads/default-avatar.png';
          }
          
          img.onerror = () => {
            console.error('Failed to load profile image, using default');
            img.src = 'http://localhost:5000/uploads/default-avatar.png';
          };
        }
      };
    
      setImage('profile-image', data.imageUrl || data.image);

    }
    // Initialize the page
    loadProfile();
  </script>
  <script src="../js/profile.js"></script>
</body>
</html>